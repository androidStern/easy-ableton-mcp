# Device Parameter Control - Session Progress

## COMPLETED: CODE_REVIEW.md Issue #1 - Bare except clauses

### Fixes applied:
- Line 88: `except:` → `except Exception:` (socket cleanup in disconnect)
- Line 197: `except:` → `except Exception as e:` + added logging (send error response)
- Line 205: `except:` → `except Exception:` (client close in finally)
- Line 985: Rewrote `_get_device_type()` to use the Live API `device.type` property instead of
  string-matching heuristics. Removed try/except entirely - errors now propagate.
  - device.type: 0=undefined, 1=instrument, 2=audio_effect, 4=midi_effect
  - Also checks can_have_drum_pads/can_have_chains for rack subtypes

### Decisions made:
- Cases 1, 3 (cleanup): Catch Exception, suppress errors - cleanup failures shouldn't block shutdown
- Case 2 (send error): Catch Exception, log the error, then break - boundary case
- Case 4 (device type): Rewrote to use proper API, no exception handling needed

---

## Completed
1. Device parameter tools implemented in MCP_Server/server.py and AbletonMCP_Remote_Script/__init__.py
2. Created scripts/dev-refresh.sh - restarts Ableton, runs install, waits for port 9877
3. Created scripts/test_mcp_tools.py - automated MCP tool tests
4. Fixed osascript permission error by using pgrep/open instead of System Events
   - Changed _is_ableton_running_macos() to use pgrep (no permissions needed)
   - Changed _launch_ableton_macos() to use `open -b` (no permissions needed)
   - Kept graceful quit via osascript (uses bundle ID, not System Events)
5. Updated dev-refresh.sh to run `uv run` install (points symlink to repo, not uv cache)
6. Created test fixture at tests/fixtures/test_session Project/test_session.als
   - Track 0 "Test-Synth": MIDI track with Drift synth + "Test Pattern" clip
   - Track 2 "Test-EQ": Audio track with EQ Eight effect
   - Tempo: 128 BPM
7. Updated dev-refresh.sh to open test fixture project automatically
8. Increased TCP wait timeout to 90s (Ableton + project loading can be slow)

## Test Results (All Passing)
- get_session_info: PASS (Tempo: 128 BPM, 4 tracks)
- get_device_parameters: PASS (Drift synth, 66 parameters)
- set_device_parameter: PASS (LP Freq = 0.5)
- batch_set_device_parameters: PASS (updated parameters)

## Usage
```bash
# Full dev cycle: restart Ableton with fixture, run tests
./scripts/dev-refresh.sh --test

# Just restart Ableton with fixture
./scripts/dev-refresh.sh

# Launch MCP Inspector for interactive testing
./scripts/dev-refresh.sh --inspector
```

---

## COMPLETED: CODE_REVIEW.md Issue #2 - Monolithic _process_command()

### Problem
`_process_command()` was 149 lines with 25+ elif branches and duplicated dispatch logic.

### Solution
Decorator-based command registry (Flask/FastAPI pattern):
- `CommandRegistry` class at module level with `@commands.register()` decorator
- `_execute_on_main_thread()` method encapsulates queue-based scheduling
- Simplified `_process_command()` reduced from 149 lines to 20 lines

### Changes Made
1. **Added CommandRegistry class** (lines 23-53)
   - `register(name, main_thread=False)` decorator
   - `is_registered()`, `get_handler_name()`, `requires_main_thread()` methods

2. **Added _execute_on_main_thread() method** (lines 241-261)
   - Encapsulates queue-based main thread scheduling
   - Handles AssertionError for already-on-main-thread case
   - Returns timeout error after 10s

3. **Updated all handlers with decorators and defaults**
   - 6 direct commands: get_session_info, get_track_info, get_browser_tree,
     get_browser_items_at_path, get_session_tree, get_device_parameters
   - 13 main-thread commands: create_midi_track, set_track_name, create_clip,
     add_notes_to_clip, set_clip_name, set_tempo, fire_clip, stop_clip,
     start_playback, stop_playback, load_browser_item, set_device_parameter,
     batch_set_device_parameters
   - Added get_browser_item (direct) for completeness

4. **Replaced _process_command()** (lines 263-282)
   - Uses registry for dispatch instead of if-elif chain
   - Single code path for both direct and main-thread commands

### Dead Code Removed
- `load_instrument_or_effect` reference (handler never existed)
- `get_browser_categories` and `get_browser_items` references (handlers never existed)

### Test Results
- 42 unit tests passing in 0.10s
- All direct commands return success and skip schedule_message
- All main-thread commands return success and use schedule_message
- Queue timeout and error propagation verified

### Live Verification (Ableton + MCP)
Ran `./scripts/dev-refresh.sh --test` with real Ableton:
- get_session_info: PASS (Tempo: 128 BPM, 4 tracks)
- get_device_parameters: PASS (Drift synth, 66 parameters)
- set_device_parameter: PASS (LP Freq = 0.5)
- batch_set_device_parameters: PASS (updated parameters)

---

## COMPLETED: CODE_REVIEW.md Issue #3 - Repetitive Tool Wrappers

### Problem
21 MCP tool functions in server.py with identical boilerplate:
- get_ableton_connection()
- send_command()
- try/except with logger.error()

### Solution
Added `@ableton_command()` decorator that handles connection, command dispatch, and error handling.

### Changes Made
1. **Added `ableton_command` decorator** (lines 178-210)
   - Takes command name, optional format_result function, optional error_context
   - Wrapped function returns params dict (or None)
   - Decorator handles try/except, logging, JSON formatting

2. **Refactored 17 tools** to use decorator:
   - get_session_info, get_session_tree, get_track_info
   - create_midi_track, set_track_name, create_clip
   - add_notes_to_clip, set_clip_name, set_tempo
   - load_instrument_or_effect, fire_clip, stop_clip
   - start_playback, stop_playback
   - get_device_parameters, set_device_parameter, batch_set_device_parameters

3. **Kept 3 tools as-is** (complex logic, separate issues):
   - get_browser_tree (custom formatting + error handling → Issue #12)
   - get_browser_items_at_path (custom error handling → Issue #12)
   - load_drum_kit (multi-step operation → Issue #15)

### Test Results
- 42 unit tests passing
- Live MCP tests passing (get_session_info, device parameter tools)

---

## COMPLETED: CODE_REVIEW.md Issue #4 - Silent Default Parameters

### Problem
Commands silently accepted missing required parameters by defaulting to 0/"":
- `track_index=0` meant forgetting the param affected track 0
- `clip_index=0` meant forgetting the param affected clip 0
- No way to distinguish "passed 0" from "forgot parameter"

### Solution
TDD approach:
1. Wrote 25 failing tests first (test_required_params.py)
2. Added `_require_param(name, value)` helper method
3. Changed defaults from `0`/`""` to `None`
4. Added validation at start of each handler

### Handlers Updated
- _get_track_info: track_index
- _set_track_name: track_index
- _create_clip: track_index, clip_index
- _add_notes_to_clip: track_index, clip_index
- _set_clip_name: track_index, clip_index
- _fire_clip: track_index, clip_index
- _stop_clip: track_index, clip_index
- _load_browser_item: track_index, item_uri
- _get_device_parameters: track_index, device_index
- _set_device_parameter: track_index, device_index, parameter_index, value
- _batch_set_device_parameters: track_index, device_index

### Test Results
- 67 tests passing (42 existing + 25 new)
- Explicit zero values still work (TestExplicitZeroStillWorks)

---

## COMPLETED: CODE_REVIEW.md Issue #10 - Repeated Index Validation

### Problem
Track index validation duplicated 9 times, clip index validation 5 times.

### Solution
Added helper methods:
- `_get_track(track_index)` - validates and returns track
- `_get_clip_slot(track_index, clip_index)` - validates and returns clip slot

Updated 14 call sites total.

### Test Results
- 67 tests passing

---

## COMPLETED: CODE_REVIEW.md Issues #8 & #9

### Issue #8 - Duplicate Normalization Logic
Extracted helper methods:
- `_normalize_param_value(param)` - actual value to 0.0-1.0
- `_denormalize_param_value(param, normalized)` - 0.0-1.0 to actual
Updated 3 call sites.

### Issue #9 - Linear Search
Replaced loop with `rfind()` - one-liner fix.

### Test Results
- 67 tests passing

---

## COMPLETED: CODE_REVIEW.md Issue #7 - Subprocess Timeout

### Problem
`subprocess.run()` calls for quitting Ableton had no timeout - could hang indefinitely.

### Solution
Added `timeout=10.0` to:
- `_quit_ableton_windows()` (taskkill)
- `_quit_ableton_macos()` (osascript)

### Test Results
- 67 tests passing

---

## COMPLETED: CODE_REVIEW.md Issue #6 - Generic Exception Raised

### Problem
Used bare `Exception` for all errors - callers couldn't distinguish error types.

### Solution
Added custom exception types:
- `AbletonCommandError` - Ableton returned an error status
- `AbletonResponseError` - Invalid/unparseable JSON response
- `ConnectionError` - Re-raised as-is (built-in, already descriptive)

### Test Results
- 67 tests passing

---

## COMPLETED: CODE_REVIEW.md Issue #5 - Broad except Exception in Connection

### Problem
`connect()` caught all exceptions identically, making diagnosis difficult.
No way to distinguish recoverable errors (retry) from unrecoverable ones (fail fast).

### Solution
Replaced broad `except Exception` with specific handlers:
- `ConnectionRefusedError` → log warning, return False (retry)
- `socket.timeout` → log warning, return False (retry)
- `OSError` → log error, raise (fail fast - permission/firewall issues won't fix themselves)

Also added:
- 5-second connect timeout (was unbounded)
- `_cleanup_socket()` helper method

### Test Results
- 67 tests passing

---

## COMPLETED: Crash Recovery Dialog Fix

### Problem
When dev-refresh.sh force-killed Ableton, a crash recovery dialog appeared requiring
manual intervention before tests could proceed.

### Root Cause
Bash glob `Live*` doesn't match paths with spaces like `Live 11.3.43`. The rm commands
were failing silently and not deleting the crash recovery files.

### Solution
Replaced glob-based rm with find commands that properly handle paths with spaces:
```bash
find ~/Library/Preferences/Ableton -maxdepth 2 -name "Crash" -type d -exec rm -rf {} +
find ~/Library/Preferences/Ableton -maxdepth 2 -name "CrashRecoveryInfo.cfg" -delete
find ~/Library/Preferences/Ableton -maxdepth 2 -name "CrashDetection.cfg" -delete
find ~/Library/Preferences/Ableton -maxdepth 2 -name "Undo" -type d -exec rm -rf {} +
```

### Test Results
- E2E tests now run without any manual intervention
- Full dev-refresh.sh --test cycle completes automatically
